<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Land vs Land – Enkel jämförelse</title>
  <style>
    :root{
      --bg:#f7f9fc; --text:#0b1220; --muted:#5a6b88; --card:#ffffff; --border:#e2e8f0;
      --accent:#2563eb; --win:#16a34a; --lose:#dc2626; --chip:#eef2f7;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text)}
    .wrap{max-width:920px; margin:32px auto; padding:0 16px}
    header{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px 18px}
    h1{font-size:22px; margin:0 0 6px}
    p{margin:6px 0 0; color:var(--muted)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; margin-top:16px}
    .row{display:grid; grid-template-columns: 1fr 1fr auto; gap:10px}
    label{font-size:12px; color:var(--muted)}
    input, select, button{font:inherit}
    input, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff}
    button{padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--accent); color:#fff; font-weight:600; cursor:pointer}
    button:disabled{opacity:.6; cursor:not-allowed}
    .hidden{display:none}
    .winner{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--chip); margin-top:10px}
    .winner strong{font-size:16px}
    .grid2{display:grid; grid-template-columns: 1fr 120px 1fr; gap:8px; margin-top:10px}
    .hdr{font-size:12px; color:var(--muted)}
    .cell{padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff}
    .metric{font-size:12px; color:var(--muted); margin-bottom:4px}
    .val{font-weight:700}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip); color:var(--muted); font-size:12px}
    .good{color:var(--win)}
    .bad{color:var(--lose)}
    .foot{font-size:12px; color:var(--muted); margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Land vs Land (Light)</h1>
      <p>Välj två länder och tryck <strong>Jämför</strong>. Inget visas förrän du väljer. Data hämtas från <code>countries.json</code>.</p>
    </header>

    <section class="card">
      <div class="row">
        <div>
          <label for="aSel">Land A</label>
          <input id="aInput" list="countryList" placeholder="Sök land ..." />
        </div>
        <div>
          <label for="bSel">Land B</label>
          <input id="bInput" list="countryList" placeholder="Sök land ..." />
        </div>
        <div style="display:flex; align-items:end;">
          <button id="compareBtn" disabled>Jämför</button>
        </div>
      </div>
      <datalist id="countryList"></datalist>

      <div id="result" class="hidden">
        <div id="winner" class="winner"></div>
        <div class="grid2">
          <div class="hdr">Land A</div>
          <div class="hdr" style="text-align:center">Mått</div>
          <div class="hdr" style="text-align:right">Land B</div>

          <!-- rows will be injected here -->
          <div id="rows" style="grid-column:1/-1"></div>
        </div>
        <div class="foot">Modellen normaliserar varje mått över hela datamängden (log-skala) och väger ihop till en poäng. Kärnvapen ger liten avskräckningsbonus (inte skadeverkan). Detta är en förenklad, icke-realistisk jämförelse.</div>
      </div>
    </section>
  </div>

  <script>
    // --- Helpers ---
    const fmt = (v)=>{
      if(v==null) return '–';
      if(typeof v!=='number' || isNaN(v)) return String(v);
      if(v>=1e12) return (v/1e12).toFixed(2)+' tn';
      if(v>=1e9) return (v/1e9).toFixed(2)+' md';
      if(v>=1e6) return (v/1e6).toFixed(1)+' M';
      if(v>=1e3) return (v/1e3).toFixed(1)+' k';
      return String(v);
    };
    const n = (v)=> (typeof v==='number' && !Number.isNaN(v)) ? v : 0;

    // Load dataset
    async function loadData(){
      const res = await fetch('countries.json', {cache:'no-store'});
      if(!res.ok) throw new Error('Kunde inte läsa countries.json');
      const js = await res.json();
      return js.countries || js;
    }

    // Extract comparable metrics from a country object
    function metrics(c){
      return {
        budget: n(c.defenseBudgetUSD),
        active: n(c.forces?.activePersonnel),
        aircraft: n(c.equipment?.aircraft),
        tanks: n(c.equipment?.tanks),
        subs: n(c.equipment?.submarines?.total) + Math.min(5, n(c.equipment?.submarines?.AIP))*0.5, // liten bonus för AIP
        airdef: n(c.equipment?.airDefenseScore),
        nuclear: c.nuclear?.status==='declared' ? 100 : c.nuclear?.status==='undeclared' ? 50 : 0,
      };
    }

    // Build normalizers from full dataset using log scaling to be fair
    function buildNormalizers(all){
      const keys = ['budget','active','aircraft','tanks','subs','airdef','nuclear'];
      const mAll = all.map(metrics);
      const ranges = {};
      for(const k of keys){
        const arr = mAll.map(m=>m[k]).filter(x=>typeof x==='number');
        const min = Math.min(...arr, 0);
        const max = Math.max(...arr, 1);
        const lmin = Math.log10(1+Math.max(0,min));
        const lmax = Math.log10(1+Math.max(0,max));
        ranges[k] = {min,max,lmin,lmax};
      }
      function norm(k, v){
        const r = ranges[k];
        const lv = Math.log10(1+Math.max(0, v));
        const span = Math.max(1e-6, r.lmax - r.lmin);
        return Math.max(0, Math.min(1, (lv - r.lmin) / span));
      }
      return { norm };
    }

    // Weighted score (weights sum to 1)
    const WEIGHTS = { budget:.25, active:.18, aircraft:.2, tanks:.15, subs:.1, airdef:.09, nuclear:.03 };

    function score(m, norm){
      let s = 0; const parts = {};
      for(const k in WEIGHTS){
        const v = norm(k, m[k]);
        const w = WEIGHTS[k];
        parts[k] = {norm:v, contrib: v*w};
        s += v*w;
      }
      return { total: s*100, parts };
    }

    function decide(a,b){
      const diff = Math.abs(a.total - b.total);
      // Beslutstid: 10–60 dagar, snabbare vid större skillnad
      const ttd = Math.round(60 - Math.min(50, diff*0.6));
      return { ttd: Math.max(10, ttd) };
    }

    // UI
    (async function(){
      let countries = [];
      try{ countries = await loadData(); }catch(err){ alert(err.message); return; }

      // Build datalist
      const dl = document.getElementById('countryList');
      countries.sort((a,b)=>a.name.localeCompare(b.name,'sv')).forEach(c=>{
        const o = document.createElement('option');
        o.value = c.name; dl.appendChild(o);
      });

      const A = document.getElementById('aInput');
      const B = document.getElementById('bInput');
      const btn = document.getElementById('compareBtn');
      const result = document.getElementById('result');
      const winner = document.getElementById('winner');
      const rows = document.getElementById('rows');

      function ready(){ btn.disabled = !(A.value && B.value && A.value!==B.value); }
      A.addEventListener('input', ready); B.addEventListener('input', ready);

      const norm = buildNormalizers(countries);

      btn.addEventListener('click', ()=>{
        const ca = countries.find(c=>c.name.toLowerCase()===A.value.toLowerCase());
        const cb = countries.find(c=>c.name.toLowerCase()===B.value.toLowerCase());
        if(!ca || !cb){ alert('Hitta båda länderna i listan.'); return; }
        const ma = metrics(ca), mb = metrics(cb);
        const sa = score(ma, norm.norm); const sb = score(mb, norm.norm);
        const { ttd } = decide(sa, sb);
        const w = sa.total===sb.total ? null : (sa.total>sb.total? ca : cb);

        // Winner banner
        winner.innerHTML = w
          ? `<span class="pill">Vinnare</span> <strong>${w.name}</strong> · poäng ${ (w===ca?sa.total:sb.total).toFixed(1) } – beslut på ~ ${ttd} dagar`
          : `<span class="pill">Oavgjort</span> <strong>${ca.name}</strong> vs <strong>${cb.name}</strong> · ~ ${ttd} dagar`;

        // Rows: show each metric side-by-side
        const labels = {
          budget:'Försvarsbudget (USD)', active:'Aktiv personal', aircraft:'Flygplan', tanks:'Stridsvagnar', subs:'Ubåtsförmåga (just.)', airdef:'Luftförsvar (0–100)', nuclear:'Kärnvapendisk.'
        };

        const makeRow = (key)=>{
          const av = ma[key], bv = mb[key];
          const an = sa.parts[key].norm, bn = sb.parts[key].norm;
          const left = `<div class="cell"><div class="metric">${ca.name}</div><div class="val ${an>bn?'good': an<bn?'bad':''}">${fmt(av)}</div></div>`;
          const mid = `<div class="cell" style="text-align:center"><div class="metric">${labels[key]}</div><div class="val">${(WEIGHTS[key]*100).toFixed(0)}% vikt</div></div>`;
          const right = `<div class="cell" style="text-align:right"><div class="metric">${cb.name}</div><div class="val ${bn>an?'good': bn<an?'bad':''}">${fmt(bv)}</div></div>`;
          return left+mid+right;
        };

        rows.innerHTML = ['budget','active','aircraft','tanks','subs','airdef','nuclear'].map(makeRow).join('');
        result.classList.remove('hidden');
      });
    })();
  </script>
</body>
</html>
